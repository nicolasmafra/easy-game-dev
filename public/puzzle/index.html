<body></body>
<script>

let canvas = document.createElement('canvas');
canvas.width = window.innerWidth - 20;
canvas.height = window.innerHeight - 20;
document.body.appendChild(canvas);

let ctx = canvas.getContext('2d');
ctx.font = '20px sans serif';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';

const gridSize = 40;
const cellSize = gridSize - 2;
const offset = gridSize;

const actions = [
    { col:  1, row:  0 },
    { col:  0, row:  1 },
    { col: -1, row:  0 },
    { col:  0, row: -1 },
];
let keyMapping = {
    "ArrowRight": actions[0],
    "ArrowDown": actions[1],
    "ArrowLeft": actions[2],
    "ArrowUp": actions[3],
}

function generateState(rows, cols) {
    let newState = [];
    let value = 0;
    for (var i = 0; i < rows; i++) {
        for (var j = 0; j < cols; j++) {
            newState.push({
                row: i,
                col: j,
                v: value,
            });
            value++;
        }
    }
    return newState;
}

function update(state, action) {
    let emptyCell = state.find(x => x.v == 0);
    let col = emptyCell.col - action.col;
    let row = emptyCell.row - action.row;

    let movedCell = state.find(x => x.row == row && x.col == col);
    
    if (movedCell) {
        emptyCell.v = movedCell.v;
        movedCell.v = 0;
    }
}

function shuffle(state, count = 1000) {
    for (var i = 0; i < count; i++) {
        let action = actions[Math.floor(actions.length * Math.random())];
        update(state, action);
    }
}

function draw(state) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    state.forEach(cell => {
        if (cell.v) {
            let x = offset + cell.col * gridSize;
            let y = offset + cell.row * gridSize;
            ctx.fillStyle = 'gray';
            ctx.fillRect(x - cellSize/2, y - cellSize/2, cellSize, cellSize);
            ctx.fillStyle = 'black';
            ctx.fillText(cell.v, x, y);
        }
    });
}

document.addEventListener('keydown', (e) => {
    let action = keyMapping[e.code];
    if (action) {
        update(currentState, action);
        draw(currentState);
    }
});

let currentState;
let params = new URLSearchParams(window.location.search);
let rows = parseInt(params.get("rows"));
let cols = parseInt(params.get("cols"));

if (!rows || !cols) {
    params.set("rows", "3");
    params.set("cols", "3");
    window.location.search = params.toString();
} else {
    currentState = generateState(rows, cols);
    shuffle(currentState);
    draw(currentState);
}
</script>
